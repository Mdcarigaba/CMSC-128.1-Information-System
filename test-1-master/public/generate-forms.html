<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Forms</title>
    <script src="https://unpkg.com/pdf-lib@1.11.0"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
    <link rel="stylesheet" type="text/css" href="css/generate-forms.css">
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css" rel="stylesheet">

</head>
<body>
    <div class="module-3-body">
        <!-- NAV BAR -->
        <nav id="nav" class="base-bg-color">
            <div class="logo">
                <img class="logo-small" src="img/logo-small.png" alt="logo-small">
                <img class="logo-word nav-component-toggle" src="img/logo-word.png" alt="logo-word">
            </div>
            <hr>
            <div class="nav-menu">
                <a class="nav-item" href="/">
                    <img class="nav-icon" src="img/home-icon.png" alt="home-icon">
                    <p class="nav-component-toggle">Home</p>
                </a>
                <a class="nav-item" href="/search-patient">
                    <img class="nav-icon" src="img/patient-icon.png" alt="patient-icon">
                    <p class="nav-component-toggle">Search Patient</p>
                </a>
                <a class="nav-item" href="/cif">
                    <img class="nav-icon" src="img/cif-icon.png" alt="cif-icon">
                    <p class="nav-component-toggle">CIF Entry</p>
                </a>
                <a class="nav-item" href="/generate-forms">
                    <img class="nav-icon" src="img/form-icon.png" alt="form-icon">
                    <p class="nav-component-toggle">Generate Forms</p>
                </a>
                <a class="nav-item" href="/DRUqueueing">
                    <img class="nav-icon" src="img/queue-icon.png" alt="queue-icon">
                    <p class="nav-component-toggle">DRU Queueing</p>
                </a>
                <div class="btn-collapse">
                    <img src="img/btn-arrow-left.png" id="close-nav" alt="arrow-left">
                </div>
                <div class="btn-expand">
                    <img src="img/btn-arrow-right.png" id="open-nav" alt="arrow-right">
                </div>
            </div>
        </nav>
    
        <div class="right-body">
            <!-- HEADER -->
            <div class="header row">
                <div class="page-title-header">
                    <div class="row">
                        
                        <div class="page-title">
                            <p>Module 3: Generate Forms</p>
                        </div>
                    </div>
                </div>
                <div class="page-action">
                    <div class="row">
                        <div>
                            <p class="user-session">Logged in as <span class="username admin-bold"></span></p>
                        </div>
                        <div class="user-icon">
                            <img src="img/user-icon.png" alt="user">
                        </div>
                        <div class="dropdown">
                            <div onclick="toggleDropdown()" class="arrow-down" id="arrow-down">
                                <img src="img/chevron-down.png" alt="arrow-down">
                            </div>
                            <div id="dropdown" class="dropdown-content">
                                <div class="user-details">
                                    <p class="user-type"></p>
                                    <p class="user-email"></p>
                                </div>
                                <div class="user-actions">
                                    <!-- <div class="edit-profile-btn">
                                        <img src="img/user-profile.png" alt="user-profile">
                                        <p>Edit Profile</p>
                                    </div> -->
                                    <div class="logout-btn">
                                        <img src="img/logout.png" alt="logout-icon">
                                        <p>Logout</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- MODULE 3 -->
            <div class="filter">
                <div class="filter-header">
                    <img class="filter-icon" src="img/filter-icon.png" alt="">
                    <span class="filter-title">Filter</span>
                </div>
                <div class="filter-body">
                    <div class="input-fields-labels1"> 
                        <span class="labels1-div">
                            <div>
                                <div class="from_label">From</div>
                                <input type="text" placeholder="MM/DD/YYYY" id="from"></input>
                            </div>
                            <div>
                                <div class="to_label">To</div>
                                <input type="text" placeholder="MM/DD/YYYY" id="to">
                            </div>
                            <div>
                                <div>
                                    <div class="lab_number_label">Laboratory Number</div> <!-- VERIFY IF LABORATORY ID NUMBER OR LAB NUMBER ONLY -->
                                    <input type="text" id="laboratory-number">
                                </div>
                            </div>
                        </span>
                    </div>
                    <div class="input-fields-labels2">
                        <span class="labels2-div">
                            <div>
                                <div class="encoder_label">Encoded by</div>
                                <input type="text" id="encoder-name">
                            </div>
                            <div>
                                <div class="dru_label">Disease Reporting Unit/Hospital</div>
                                <input type="text" id="dru-label">
                            </div>
                        </span>
                    </div>
                    <div class="search-btn-div"> <!-- to be renamed to filter -->
                        <button type="submit" class="search-btn" onclick="filterTable()"><img class="search-icon" src="img/search-icon.png" alt="">Filter</button>
                    </div>
                </div>
            </div>
            <!--
            <div class = "batch-generation-header">
                <div class="batch-generation-label"> Batch Generation </div>
                <div class="batch-btn-div"> 
                    <button type="submit" class="export-selected-btn">Export Selected</button>
                    <button type="submit" class="export-to-pdf-btn">Export to PDF</button>
                    <button type="submit" class="export-to-excel-btn">Export to Excel</button>
                </div>
            </div> 
            -->
            <div class="list-desc">
                <!-- <span> -->
                    <div class="l1">List of Records</div>
                    <div class="l2">
                        No. of Entries Shown
                        <input type="text" name="" id="num-entries">
                    </div>
                <!-- </span> -->
            </div>
            <div class="generate-forms-table">
                <table class="recordsTable" cellspacing="0">
                    <thead>
                        <tr class="records-table-header">
                            <th id="first-col"><input type ="checkbox"></th>
                            <th>CIF No.</th>
                            <th>Lab No.</th>
                            <th>Last Name</th>
                            <th>First Name</th>
                            <!--<th>Middle Name</th>-->
                            <th>Gender</th>
                            <th>Age</th>
                            <th>Date Collected</th>
                            <th>Date Submitted</th>
                            <th>DRU</th>
                            <!--<th>Final Classification</th>-->
                            <th id="last-col">Action</th>
                        </tr>
                    </thead>
    
                    <tbody id="tableData">
    
                    </tbody>
                </table>
            </div>
            <div class="pagination_section" style="display: flex; min-width: 900px;">
                <div id="counterDiv"> 
                    <!-- n is number of "entries shown" -->
                    Showing 1-n of *total* entries
                <!-- <input id="counter" type="number" value="0" readonly> -->
                </div>
                <div class="btns">
                    <button class="back-next">&lt;</button>
                    <button class="back-next">></button>
                </div>
                <div id="pageCounterDiv"> 
                    <!-- n is number of "entries shown" -->
                    Page <span id="pagination-page"></span> of <span>*total*</span> pages
                </div>
            </div>
        </div>
    </div>
    <script>
        const { PDFDocument } = PDFLib

        function generateSpecPDF (index) {
            const body = this.document.querySelector("#tableData")
            const  id = parseInt(body.childNodes[index].childNodes[1].innerHTML.split('-')[1])
            console.log(id)
            fetch(`/generate-pdf?cif.id=${id}`,{
                method: 'get',
                headers: new Headers({'Content-Type': 'application/json'})
            })
            .then(res => res.json())
            .then(data => fillForm(data))
        }
    
        async function fillForm(data) {
            console.log(data)
            // Fetch the PDF with form fields
          //const formUrl = 'https://pdf-lib.js.org/assets/dod_character.pdf'
          const formUrl = 'http://dl.dropboxusercontent.com/s/mmufx0ddjqo4iqi/CIF_-_Version_9_fillable-2.pdf'
          const formPdfBytes = await fetch(formUrl).then(res => res.arrayBuffer())
    
          // Load a PDF with form fields
          const pdfDoc = await PDFDocument.load(formPdfBytes)
    
          // Get the form containing all the fields
          const form = pdfDoc.getForm()
    
          // Get all fields in the PDF by their names

            const diseaseReportingUnitField = form.getTextField('Disease Reporting Unit')
            diseaseReportingUnitField.setText(data[0].dru)
  
            const nameOfInterviewerField = form.getTextField('Name of Interviewer')
            nameOfInterviewerField.setText(`${data[0].interviewer_last}, ${data[0].interviewer_first}`)
  
            const dateOfInterviewField = form.getTextField("Date of Interview")
            dateOfInterviewField.setText(data[0].interview_date)
  
            const relationshipOfInformantField = form.getTextField('Relationship')
            relationshipOfInformantField.setText((data[0].relation == null) ? "": data[0].relation )
  
            const informantPhoneNoField = form.getTextField('Contact Number of Informant')
            informantPhoneNoField.setText(data[0].informant_contact)

            const philhealthNoField = form.getTextField('PhilHealth No')
            philhealthNoField.setText(data[0].philhealth)
            
            const lastnameField = form.getTextField('Last Name')
            lastnameField.setText(data[0].patient_lastname)
    
            const nameOfInformantField = form.getTextField('Name of Informant')
            nameOfInformantField.setText(data[0].informant)

            const firstNameField = form.getTextField('First Name and Suffix')
            firstNameField.setText(data[0].patient_firstname)
    
            const middleNameField = form.getTextField('Middle Name')
            middleNameField.setText(data[0].patient_middlename)
    
            const birthdayField = form.getTextField('Birthday')
            birthdayField.setText(data[0].patient_birthday)
    
            const ageField = form.getTextField('Age')
            ageField.setText(data[0].patient_age.toString())
    
            const sexField = form.getRadioGroup('Sex')
            //sexField.setRadio(document.getElementById("sex").value)

            const civilStatusField = form.getDropdown('Civil Status')
            //civilStatusField.setText(document.getElementById("civil-status").value)
    
            const nationalityField = form.getTextField('Nationality')
            nationalityField.setText(data[0].patient_nationality)
    
            const occupationField = form.getTextField('Occupation')
            occupationField.setText(data[0].patient_occupation)

            //current
            const houseNoLotBldgRow1Field = form.getTextField('House NoLotBldgRow1')
            houseNoLotBldgRow1Field.setText(data[0].current_hn_bl_lot_buildno)

            const barangayRow1Field = form.getTextField('BarangayRow1')
            barangayRow1Field.setText(data[0].current_barangay)
            
            const municipalityCityRow1Field = form.getTextField('MunicipalityCityRow1')
            municipalityCityRow1Field.setText(data[0].current_muni_city)

            const provinceRow1Field = form.getTextField('ProvinceRow1')
            provinceRow1Field.setText(data[0].current_province)
            
            const homePhoneNoAreaCodeRow1Field = form.getTextField('Home Phone No  Area CodeRow1')
            homePhoneNoAreaCodeRow1Field.setText(data[0].current_home_no)

            const cellphoneNoRow1Field = form.getTextField('Cellphone NoRow1')
            cellphoneNoRow1Field.setText(data[0].current_cell_no)

            const emailAddressRow1Field = form.getTextField('Email AddressRow1')
            emailAddressRow1Field.setText(data[0].current_email)

            const houseNoLotBldgRow1_2Field = form.getTextField('House NoLotBldgRow1_2')
            houseNoLotBldgRow1_2Field.setText(data[0].permanent_hn_bl_lot_buildno)

            const barangayRow1_2Field = form.getTextField('BarangayRow1_2')
            barangayRow1_2Field.setText(data[0].patient_permanent_barangay)
    
            const municipalityCityRow1_2Field = form.getTextField('MunicipalityCityRow1_2')
            municipalityCityRow1_2Field.setText(data[0].permanent_muni_city)
            
            const provinceRow1_2Field = form.getTextField('ProvinceRow1_2')
            provinceRow1_2Field.setText(data[0].permanent_province)
    
            const homePhoneNoAreaCodeRow1_2Field = form.getTextField('Home Phone No  Area CodeRow1_2')
            homePhoneNoAreaCodeRow1_2Field.setText(data[0].permanent_home_no)
    
            const cellphoneNoRow1_2Field = form.getTextField('Cellphone NoRow1_2')
            cellphoneNoRow1_2Field.setText(data[0].permanent_cell_no)
    
            const emailAddressRow1_2Field = form.getTextField('Email AddressRow1_2')
            emailAddressRow1_2Field.setText(data[0].permanent_email)

            const barangayRow1_3Field = form.getTextField('BarangayRow1_3')
            //barangayRow1_3Field = form.setText(querySelector('.'))
    
            const municipalityCityRow1_3Field = form.getTextField('MunicipalityCityRow1_3')
            municipalityCityRow1_3Field.setText(data[0].workplace_muni_city)
    
            const provinceRow1_3Field = form.getTextField('ProvinceRow1_3')
            provinceRow1_3Field.setText(data[0].workplace_province)
    
            const nameofWorkplaceRow1Field = form.getTextField('Name of WorkplaceRow1')
            nameofWorkplaceRow1Field.setText(data[0].workplace_name)
            
            const phoneNoCellphoneNoRow1 = form.getTextField('Phone NoCellphone NoRow1')
            phoneNoCellphoneNoRow1.setText(data[0].workplace_cell_no)

            const ifInternationalTravelCountryofOriginField = form.getTextField('If International Travel country of origin')
            //ifInternationalTravelCountryofOriginField.setText(document.querySelector('.exit-port').value)
    
            //const airlineSeaVesselNumberField = form.getTextField('AirlineSeavessel Row1')
            //airlineSeaVesselNumberField.setText(document.querySelector('.airline-seavessel').value)
    
            const flightVesselNumberRow1Field = form.getTextField('FlightVessel NumberRow1')
            //flightVesselNumberRow1Field.setText(document.querySelector('.flight-vessel-no').value)

            const dateOfOnsetOfIllnessField = form.getTextField('Date of Onset of Illness')
            dateOfOnsetOfIllnessField.setText(data[0].date_of_onset_illness)

            //const isPregnant = form.getRadioGroup('')

            const testingCategoryAField = form.getCheckBox('Testing Category: A')
            testingCategoryAField.check();
    
            const isAsymptomaticField = form.getCheckBox('SS1');
            //if ( $('#asymptomatic').is(':checked')) {isAsymptomaticField.check();}  
            if (data[0].is_asymptomatic){
                isAsymptomaticField.check();
            }  

            const isFeverField = form.getCheckBox('SS2');
            if(data[0].have_fever){
                isFeverField.check();
            }
    
            const isCoughField = form.getCheckBox('SS3');
            //const cb3 = document.querySelector();
            if(data[0].have_cough){
                isCoughField.check();
            }
    
            const isWeaknessField = form.getCheckBox('SS4');
            if(data[0].have_general_weakness){
                isWeaknessField.check();
            }
    
            const isFatigueField = form.getCheckBox('SS5');
            if(data[0].experiences_fatigue){
                isFatigueField.check();
            }
    
            const isHeadacheField = form.getCheckBox('SS6');
            if(data[0].have_headache){
                isHeadacheField.check();
            }
    
            const isMyalgiaField = form.getCheckBox('SS7');
            if(data[0].have_myalgia){
                isFeverField.check();
            }
    
            const isSoreThroatField = form.getCheckBox('SS8');
            if(data[0].have_sore_throat){
                isSoreThroatField.check();
            }
    
            const isCoryzaField = form.getCheckBox('SS9');
            //const cb9 = document.querySelector(data[0].have_coryza);
            if(data[0].have_coryza){
                isCoryzaField.check();
            }
    
            const isAlteredMentalStatusField = form.getCheckBox('SS10');
            //const cb10 = document.querySelector('#altered_mental_status');
            if(data[0].exp_altered_mental_status){
                isAlteredMentalStatusField.check();
            }
    
            const isDyspneaField = form.getCheckBox('SS11');
            //const cb11 = document.querySelector(data[0].have_dyspnea);
            if(data[0].have_dyspnea){
                isDyspneaField.check();
            }
    
            /*
            const isAnorexiaField = form.getCheckBox('SS12');
            const cb12 = document.querySelector(data[0].have_anorexia);
            if(cb12.checked){
                isAnorexiaField.check();
            }*/
    
            const isNauseaField = form.getCheckBox('SS13');
            //const cb13 = document.querySelector(data[0].experiences_nausea);
            if(data[0].experiences_nausea){
                isFatigueField.check();
            }
    
            // /*
            // const isVomitingField = form.getCheckBox('SS14');
            // const cb14 = document.querySelector('#vomiting');
            // if(cb14.checked){
            //     isVomitingField.check();
            // }
    
            // const isDiarrheaField = form.getCheckBox('SS15');
            // const cb15 = document.querySelector('#diarrhea');
            // if(cb15.checked){
            //     isDiarrheaField.check();
            // }*/
    
            const isAnosmiaField = form.getCheckBox('SS16');
            if(data[0].exp_anosmia){
                isAnosmiaField.check();
            }
    
            const isAgeusiaField = form.getCheckBox('SS17');
            if(data[0].exp_ageusia){
                isAgeusiaField.check();
            }

          // Serialize the PDFDocument to bytes (a Uint8Array)
          const pdfBytes = await pdfDoc.save()
    
                // Trigger the browser to download the PDF document
          download(pdfBytes, "CIF.pdf", "application/pdf");
        }
      </script> 
    <script src="js/index.js"></script>
    <script src="js/home.js"></script>
    <script type="text/javascript" src="js/generate-forms.js"></script>
    <script type="text/javascript" src="js/logout.js"></script>
</body>
</html>
